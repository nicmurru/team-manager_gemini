<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Manager - Sistema Completo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #334155;
            line-height: 1.6;
        }

        /* LOGIN STYLES */
        #loginScreen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .logo h1 {
            color: #333;
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
            text-align: center;
        }

        .logo p {
            color: #666;
            font-size: 14px;
            text-align: center;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            background: white;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #loginButton {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #loginButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
            display: none;
        }

        .error {
            background: rgba(255, 82, 82, 0.1);
            color: #ff5252;
            border: 1px solid rgba(255, 82, 82, 0.2);
        }

        .success {
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
            border: 1px solid rgba(76, 175, 80, 0.2);
        }

        .demo-info {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
            border-left: 4px solid #667eea;
        }

        .demo-info h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 12px;
        }

        .demo-info div {
            margin-bottom: 8px;
            font-size: 14px;
            color: #555;
        }

        /* DASHBOARD STYLES */
        #dashboardScreen {
            display: none;
            background: #f8fafc;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }

        .stat-card h3 {
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
        }

        .section-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .section-header {
            background: #f8fafc;
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            font-size: 20px;
            color: #1e293b;
            margin: 0;
        }

        .section-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        /* Manager/Member specific sections */
        .manager-only {
            display: none !important;
        }

        .manager-only.show {
            display: block !important;
        }

        .member-only {
            display: none !important;
        }

        .member-only.show {
            display: block !important;
        }

        /* Filter Controls */
        .filter-controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-toggle {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-toggle.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* Gantt Chart */
        .gantt-container {
            min-width: 1000px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .gantt-header {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .gantt-task-column {
            width: 300px;
            padding: 12px;
            font-weight: 600;
            color: #1e293b;
            border-right: 1px solid #e2e8f0;
        }

        .gantt-timeline-header {
            flex: 1;
            display: flex;
        }

        .gantt-date-cell {
            min-width: 40px;
            padding: 8px 4px;
            text-align: center;
            border-right: 1px solid #e2e8f0;
            font-size: 11px;
            font-weight: 500;
            color: #64748b;
        }

        .gantt-row {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            min-height: 60px;
            align-items: center;
        }

        .gantt-task-info {
            width: 300px;
            padding: 12px;
            border-right: 1px solid #e2e8f0;
        }

        .gantt-timeline {
            flex: 1;
            display: flex;
            position: relative;
            align-items: center;
            min-height: 60px;
        }

        .gantt-date-column {
            min-width: 40px;
            height: 100%;
            border-right: 1px solid #f1f5f9;
            display: flex;
            align-items: center;
        }

        .gantt-bar {
            position: absolute;
            height: 24px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: 600;
            z-index: 2;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .gantt-bar:hover {
            transform: scaleY(1.2);
            z-index: 3;
        }

        .gantt-area {
            padding: 20px;
            overflow-x: auto;
        }

        .task-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: #1e293b;
        }

        .task-members {
            display: flex;
            gap: 4px;
            margin-top: 5px;
        }

        .member-tag {
            background: #667eea;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
        }

        .task-comments {
            font-size: 11px;
            color: #64748b;
            margin-top: 4px;
            font-style: italic;
        }

        .progress-completed { background: #10b981; }
        .progress-progress { background: #3b82f6; }
        .progress-planning { background: #f59e0b; }
        .progress-review { background: #f97316; }

        /* Tables */
        .tasks-table-container,
        .members-table-container {
            padding: 20px;
            overflow-x: auto;
        }

        .tasks-table,
        .members-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        .tasks-table th,
        .tasks-table td,
        .members-table th,
        .members-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .tasks-table th,
        .members-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #1e293b;
            position: sticky;
            top: 0;
        }

        .tasks-table tr:hover,
        .members-table tr:hover {
            background: #f8fafc;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-header h3 {
            margin: 0;
            color: #1e293b;
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        /* Task Management */
        .task-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .task-form-full {
            grid-column: 1 / -1;
        }

        .members-selector {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            background: #f8fafc;
        }

        .member-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .member-checkbox:hover {
            background: #e2e8f0;
        }

        .member-checkbox input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .member-checkbox-avatar {
            width: 25px;
            height: 25px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
        }

        .difficulty-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .difficulty-option {
            padding: 8px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            text-align: center;
            min-width: 60px;
        }

        .difficulty-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .difficulty-1 { border-color: #10b981; }
        .difficulty-1.selected { background: #10b981; }
        .difficulty-2 { border-color: #f59e0b; }
        .difficulty-2.selected { background: #f59e0b; }
        .difficulty-3 { border-color: #ef4444; }
        .difficulty-3.selected { background: #ef4444; }

        /* User Tasks Styles */
        .user-tasks-container {
            padding: 20px;
        }

        .user-task-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .user-task-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .user-task-card.completed {
            opacity: 0.7;
            background: #f0fdf4;
            border-color: #22c55e;
        }

        .task-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .task-card-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .task-card-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-planning { background: #fef3c7; color: #92400e; }
        .status-progress { background: #dbeafe; color: #1e40af; }
        .status-completed { background: #dcfce7; color: #166534; }
        .status-review { background: #fed7d7; color: #c53030; }

        .task-card-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .task-info-item {
            font-size: 14px;
        }

        .task-info-label {
            font-weight: 500;
            color: #64748b;
            margin-bottom: 2px;
        }

        .task-info-value {
            color: #1e293b;
        }

        .task-card-description {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #475569;
            border-left: 3px solid #667eea;
        }

        .completion-section {
            border-top: 1px solid #e2e8f0;
            padding-top: 15px;
            margin-top: 15px;
        }

        .completion-textarea {
            width: 100%;
            min-height: 80px;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            resize: vertical;
        }

        .completion-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .completion-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .completion-checkbox label {
            font-weight: 500;
            color: #1e293b;
            cursor: pointer;
        }

        /* Save Status */
        .save-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1001;
            transition: all 0.3s ease;
            display: none;
        }

        .save-status.saving {
            background: #fef3c7;
            color: #92400e;
        }

        .save-status.saved {
            background: #dcfce7;
            color: #166534;
        }

        .save-status.error {
            background: #fecaca;
            color: #dc2626;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            .modal-content {
                margin: 10px;
                padding: 20px;
            }
            .section-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            .section-actions {
                width: 100%;
                justify-content: flex-start;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .task-form-grid {
                grid-template-columns: 1fr;
            }
            .task-card-info {
                grid-template-columns: 1fr;
            }
            .filter-controls {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <!-- Save Status -->
    <div id="saveStatus" class="save-status"></div>

    <!-- LOGIN SCREEN -->
    <div id="loginScreen">
        <div class="login-box">
            <div class="logo">
                <h1>Team Manager</h1>
                <p>Accedi al tuo account</p>
            </div>
            <div id="messageArea" class="message"></div>
            <div class="input-group">
                <label for="usernameInput">Username</label>
                <input type="text" id="usernameInput" autocomplete="username">
            </div>
            <div class="input-group">
                <label for="passwordInput">Password</label>
                <input type="password" id="passwordInput" autocomplete="current-password">
            </div>
            <button id="loginButton">Accedi</button>
            <div class="demo-info">
                <h3>üîê Credenziali di Accesso</h3>
                <div>Contatta l'amministratore per le tue credenziali o consulta la documentazione fornita.</div>
                <div>Per i test: Credenziali Manager e Membro generico sono disponibili internamente.</div>
                <div id="googleScriptConnectionStatus" style="margin-top: 15px; font-weight: bold;"></div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD SCREEN -->
    <div id="dashboardScreen">
        <div class="header">
            <div class="header-content">
                <div>
                    <h1>üéØ Dashboard Manager</h1>
                    <p>Gestisci il tuo team e progetti</p>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">AM</div>
                    <div>
                        <div id="userDisplayName">Admin Manager</div>
                        <button onclick="logout()" style="background: rgba(255, 255, 255, 0.2); border: none; color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">Logout</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-container">
            <!-- STATISTICHE -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Attivit√† Totali</h3>
                    <div class="value" id="totalTasks">0</div>
                </div>
                <div class="stat-card">
                    <h3>In Corso</h3>
                    <div class="value" id="inProgressTasks">0</div>
                </div>
                <div class="stat-card">
                    <h3>Completate</h3>
                    <div class="value" id="completedTasks">0</div>
                </div>
                <div class="stat-card">
                    <h3>Membri Team</h3>
                    <div class="value" id="totalMembers">0</div>
                </div>
            </div>

            <!-- GANTT CHART -->
            <div class="section-card">
                <div class="section-header">
                    <div>
                        <h2>üìä Gantt Chart - Progetti Team</h2>
                        <p id="ganttSubtitle">Panoramica completa di tutte le attivit√† del team</p>
                    </div>
                    <div class="section-actions">
                        <button class="btn btn-secondary" onclick="testGoogleScriptConnection()">üîß Test Connessione</button>
                        <button class="btn btn-primary" onclick="refreshData()">üîÑ Aggiorna</button>
                    </div>
                </div>
                <div class="manager-only show">
                    <div class="filter-controls" style="padding: 20px; padding-bottom: 0;">
                        <span style="font-weight: 500; color: #1e293b;">Visualizza:</span>
                        <button class="filter-toggle active" id="showActiveBtn" onclick="toggleTaskView('active')">Attivit√† in Corso</button>
                        <button class="filter-toggle" id="showCompletedBtn" onclick="toggleTaskView('completed')">Attivit√† Completate</button>
                    </div>
                </div>
                <div class="gantt-area">
                    <div class="gantt-container" id="ganttContainer"></div>
                </div>
            </div>

            <!-- SEZIONE ATTIVIT√Ä UTENTE (SOLO MEMBRI) -->
            <div class="section-card member-only">
                <div class="section-header">
                    <div>
                        <h2>‚úÖ Le Mie Attivit√†</h2>
                        <p>Gestisci le attivit√† a te assegnate</p>
                    </div>
                </div>
                <div class="user-tasks-container">
                    <div id="userTasksList"></div>
                </div>
            </div>

            <!-- GESTIONE ATTIVIT√Ä (SOLO MANAGER) -->
            <div class="section-card manager-only">
                <div class="section-header">
                    <div>
                        <h2>üìã Gestione Attivit√†</h2>
                    </div>
                    <div class="section-actions">
                        <button class="btn btn-success" onclick="exportToExcel()">üìä Esporta Excel</button>
                        <button class="btn btn-primary" onclick="openAddTaskModal()">‚ûï Nuova Attivit√†</button>
                    </div>
                </div>
                <div class="tasks-table-container">
                    <table class="tasks-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Membri</th>
                                <th>Date</th>
                                <th>Stato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="tasksTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- GESTIONE MEMBRI (SOLO MANAGER) -->
            <div class="section-card manager-only">
                <div class="section-header">
                    <div>
                        <h2>üë• Gestione Membri</h2>
                    </div>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="openAddMemberModal()">‚ûï Aggiungi Membro</button>
                    </div>
                </div>
                <div class="members-table-container">
                    <table class="members-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Username</th>
                                <th>Attivit√†</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="membersTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal per Gestione Membri -->
    <div id="memberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Aggiungi Nuovo Membro</h3>
                <button class="close-btn" onclick="closeMemberModal()">&times;</button>
            </div>
            <form id="memberForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="memberFirstName">Nome *</label>
                        <input type="text" id="memberFirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="memberLastName">Cognome *</label>
                        <input type="text" id="memberLastName" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="memberUsername">Username *</label>
                        <input type="text" id="memberUsername" required>
                    </div>
                    <div class="form-group">
                        <label for="memberPassword">Password *</label>
                        <input type="password" id="memberPassword" required>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeMemberModal()">Annulla</button>
                    <button type="button" class="btn btn-success" onclick="saveMemberData()">Salva Membro</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal per Gestione Attivit√† -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="taskModalTitle">Nuova Attivit√†</h3>
                <button class="close-btn" onclick="closeTaskModal()">&times;</button>
            </div>
            <form id="taskForm">
                <div class="task-form-grid">
                    <div class="form-group">
                        <label for="taskName">Nome Attivit√† *</label>
                        <input type="text" id="taskName" required>
                    </div>
                    <div class="form-group">
                        <label for="taskDifficulty">Difficolt√† *</label>
                        <div class="difficulty-selector">
                            <div class="difficulty-option difficulty-1" data-difficulty="1">1</div>
                            <div class="difficulty-option difficulty-2" data-difficulty="2">2</div>
                            <div class="difficulty-option difficulty-3" data-difficulty="3">3</div>
                        </div>
                    </div>
                </div>
                <div class="form-group task-form-full">
                    <label for="taskDescription">Descrizione *</label>
                    <textarea id="taskDescription" rows="3" required></textarea>
                </div>
                <div class="task-form-grid">
                    <div class="form-group">
                        <label for="taskStartDate">Data Inizio *</label>
                        <input type="date" id="taskStartDate" required>
                    </div>
                    <div class="form-group">
                        <label for="taskEndDate">Data Fine *</label>
                        <input type="date" id="taskEndDate" required>
                    </div>
                </div>
                <div class="form-group task-form-full">
                    <label>Assegna Membri *</label>
                    <div class="members-selector" id="membersSelector"></div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeTaskModal()">Annulla</button>
                    <button type="button" class="btn btn-success" onclick="saveTaskData()">Salva Attivit√†</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // === CONFIGURAZIONE E DATI ===
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzAa-nR81-kSmdJD1r45_dWe10ZQp_Fe1NipnjevdUMwpYdBkMDec6JZtPAfDL6iOUd/exec';
        const STORAGE_KEY = 'teamManagerData_v4';

        // Credenziali
        const credentials = {
            manager: { username: 'admin', password: 'Olbia2025@' },
            member: { username: 'user', password: 'team456' }
        };

        // Dati di default
        // Dati di default con i membri reali del progetto
        const defaultMembers = [
            { id: 1, firstName: 'Mauro', lastName: 'Deligios', username: 'mdeligios', password: 'pass123', avatar: 'MD', createdAt: '2025-07-01T09:00:00.000Z' },
            { id: 2, firstName: 'Sebastiana', lastName: 'Unali', username: 'sunali', password: 'pass123', avatar: 'SU', createdAt: '2025-07-01T09:15:00.000Z' },
            { id: 3, firstName: 'Elisa', lastName: 'Pinna', username: 'epinna', password: 'pass123', avatar: 'EP', createdAt: '2025-07-01T09:30:00.000Z' },
            { id: 4, firstName: 'Valentina', lastName: 'Tolu', username: 'vtolu', password: 'pass123', avatar: 'VT', createdAt: '2025-07-01T09:45:00.000Z' },
            { id: 5, firstName: 'Arturo', lastName: 'Italia', username: 'aitalia', password: 'pass123', avatar: 'AI', createdAt: '2025-07-01T10:00:00.000Z' },
            { id: 6, firstName: 'Alessia', lastName: 'Folino', username: 'afolino', password: 'pass123', avatar: 'AF', createdAt: '2025-07-01T10:15:00.000Z' },
            { id: 7, firstName: 'Antonio', lastName: 'Mocci', username: 'amocci', password: 'pass123', avatar: 'AM', createdAt: '2025-07-01T10:30:00.000Z' },
            { id: 8, firstName: 'Laura', lastName: 'Casedda', username: 'lcasedda', password: 'pass123', avatar: 'LC', createdAt: '2025-07-01T10:45:00.000Z' },
            { id: 9, firstName: 'Victor Juan', lastName: 'Bergamo', username: 'vjbergamo', password: 'pass123', avatar: 'VB', createdAt: '2025-07-01T11:00:00.000Z' },
            { id: 10, firstName: 'Federico', lastName: 'Mureddu', username: 'fmureddu', password: 'pass123', avatar: 'FM', createdAt: '2025-07-01T11:15:00.000Z' },
            { id: 11, firstName: 'Caterina', lastName: 'Soro', username: 'csoro', password: 'pass123', avatar: 'CS', createdAt: '2025-07-01T11:30:00.000Z' },
            { id: 12, firstName: 'Marco', lastName: 'Marcato', password: 'pass123', avatar: 'MM', createdAt: '2025-07-01T11:45:00.000Z' }
        ];

        const defaultTasks = [
            { 
                id: 1, 
                name: 'Analisi Requisiti', 
                description: 'Raccolta e analisi dei requisiti del progetto', 
                members: [1, 2], // Mauro, Sebastiana
                status: 'completed', 
                startDate: '2025-07-01', 
                endDate: '2025-07-05', 
                progress: 100, 
                difficulty: 2, 
                createdAt: '2025-07-01T10:00:00.000Z',
                assignedAt: '2025-07-01T10:00:00.000Z',
                completedAt: '2025-07-05T16:30:00.000Z',
                comments: [
                    { memberId: 1, comment: 'Completata analisi stakeholder e documentazione requisiti funzionali', timestamp: '2025-07-05T16:30:00.000Z' }
                ]
            },
            { 
                id: 2, 
                name: 'Design UI/UX', 
                description: 'Progettazione interfaccia utente e user experience', 
                members: [3, 4], // Elisa, Valentina
                status: 'completed', 
                startDate: '2025-07-06', 
                endDate: '2025-07-12', 
                progress: 100, 
                difficulty: 3, 
                createdAt: '2025-07-01T10:15:00.000Z',
                assignedAt: '2025-07-01T10:15:00.000Z',
                completedAt: '2025-07-12T18:45:00.000Z',
                comments: [
                    { memberId: 3, comment: 'Wireframe e mockup completati, includendo versione mobile responsive', timestamp: '2025-07-12T18:45:00.000Z' }
                ]
            },
            { 
                id: 3, 
                name: 'Sviluppo Backend', 
                description: 'Implementazione logica server e database', 
                members: [5, 7, 10], // Arturo, Antonio, Federico
                status: 'progress', 
                startDate: '2025-07-08', 
                endDate: '2025-07-18', 
                progress: 65, 
                difficulty: 3, 
                createdAt: '2025-07-01T10:30:00.000Z',
                assignedAt: '2025-07-01T10:30:00.000Z',
                comments: []
            },
            { 
                id: 4, 
                name: 'Sviluppo Frontend', 
                description: 'Sviluppo interfaccia utente responsive', 
                members: [6, 9], // Alessia, Victor Juan
                status: 'progress', 
                startDate: '2025-07-13', 
                endDate: '2025-07-22', 
                progress: 40, 
                difficulty: 2, 
                createdAt: '2025-07-01T10:45:00.000Z',
                assignedAt: '2025-07-01T10:45:00.000Z',
                comments: []
            },
            { 
                id: 5, 
                name: 'Testing & QA', 
                description: 'Test funzionali e controllo qualit√†', 
                members: [8, 11, 12], // Laura, Caterina, Marco
                status: 'planning', 
                startDate: '2025-07-19', 
                endDate: '2025-07-25', 
                progress: 0, 
                difficulty: 2, 
                createdAt: '2025-07-01T11:00:00.000Z',
                assignedAt: '2025-07-01T11:00:00.000Z',
                comments: []
            }
        ];

        // Variabili globali
        let teamMembers = [];
        let tasks = [];
        let deletedTasks = [];
        let nextMemberId = 13;
        let nextTaskId = 6;
        let currentRole = null;
        let currentUser = null;
        let currentEditingMember = null;
        let currentEditingTask = null;
        let currentTaskView = 'active'; // 'active' or 'completed'

        // DOM Elements
        let loginScreen, dashboardScreen, usernameInput, passwordInput, loginButton, messageArea, userAvatar, userDisplayName, saveStatus, googleScriptConnectionStatus;

        // === FUNZIONI DI TEST E DIAGNOSTICA ===
        async function testGoogleScriptConnection() {
            console.log('üîç Test connessione Google Apps Script...');
            const statusElement = document.getElementById('googleScriptConnectionStatus');
            statusElement.textContent = 'Verifica connessione Google Script...';
            statusElement.style.color = '#f59e0b'; // Arancione per "in corso"
            
            // Test URL diretto
            console.log('0. Test URL diretto...');
            const testUrl = GOOGLE_APPS_SCRIPT_URL + '?action=test';
            console.log('URL di test:', testUrl);
            
            try {
                // Test con fetch
                console.log('1. Test fetch con text/plain...');
                const fetchResponse = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    body: JSON.stringify({
                        action: 'test'
                    })
                });
                
                const fetchResult = await fetchResponse.json();
                console.log('‚úÖ Fetch riuscito:', fetchResult);
                
                if (fetchResult.success) {
                    statusElement.textContent = '‚úÖ Connessione Google Script OK';
                    statusElement.style.color = '#10b981'; // Verde per successo
                    return true;
                }
            } catch (error) {
                console.log('‚ùå Fetch fallito:', error.message);
            }
            
            try {
                // Test con GET diretto
                console.log('1.5. Test GET diretto...');
                const getResponse = await fetch(testUrl, {
                    method: 'GET'
                });
                
                const getResult = await getResponse.json();
                console.log('‚úÖ GET riuscito:', getResult);
                
                if (getResult.success) {
                    statusElement.textContent = '‚úÖ Connessione Google Script OK';
                    statusElement.style.color = '#10b981'; // Verde per successo
                    return true;
                }
            } catch (error) {
                console.log('‚ùå GET fallito:', error.message);
            }
            
            try {
                // Test con JSONP
                console.log('2. Test JSONP...');
                const jsonpResult = await new Promise((resolve, reject) => {
                    const callbackName = 'testCallback_' + Date.now();
                    const script = document.createElement('script');
                    
                    window[callbackName] = function(response) {
                        document.head.removeChild(script);
                        delete window[callbackName];
                        resolve(response);
                    };
                    
                    script.src = `${GOOGLE_APPS_SCRIPT_URL}?action=test&callback=${callbackName}`;
                    script.onerror = () => {
                        document.head.removeChild(script);
                        delete window[callbackName];
                        reject(new Error('Script load failed'));
                    };
                    
                    document.head.appendChild(script);
                    
                    setTimeout(() => {
                        if (window[callbackName]) {
                            document.head.removeChild(script);
                            delete window[callbackName];
                            reject(new Error('Timeout'));
                        }
                    }, 10000);
                });
                
                console.log('‚úÖ JSONP riuscito:', jsonpResult);
                
                if (jsonpResult.success) {
                    statusElement.textContent = '‚úÖ Connessione Google Script OK';
                    statusElement.style.color = '#10b981'; // Verde per successo
                    return true;
                }
            } catch (error) {
                console.log('‚ùå JSONP fallito:', error.message);
            }
            
            // Mostra istruzioni di risoluzione problemi
            const errorMsg = `‚ùå Connessione Google Script Fallita.
            Verifica le impostazioni di deployment:
            1. Apri il tuo progetto Google Apps Script.
            2. Clicca su "Deploy" (Distribuisci) -> "New deployment" (Nuova distribuzione).
            3. Assicurati che "Execute as" (Esegui come) sia "Me" (Me) e "Who has access" (Chi ha accesso) sia "Anyone" (Chiunque).
            4. Riprova.`;
            
            statusElement.innerHTML = errorMsg.replace(/\n/g, '<br>'); // Permette i salti di riga
            statusElement.style.color = '#ef4444'; // Rosso per errore
            showMessage('‚ùå Errore di connessione a Google Script. Controlla il messaggio sotto le credenziali.', 'error');

            console.log('üîß Istruzioni risoluzione:');
            console.log('1. Vai su Google Apps Script');
            console.log('2. Deploy ‚Üí New deployment');
            console.log('3. Execute as: Me, Who has access: Anyone');
            console.log('4. Testa questo URL:', testUrl);
            
            return false;
        }

        // === SISTEMA DI PERSISTENZA ===
        async function saveData() {
            try {
                showSaveStatus('saving');
                
                const data = {
                    teamMembers: teamMembers,
                    tasks: tasks,
                    deletedTasks: deletedTasks,
                    nextMemberId: nextMemberId,
                    nextTaskId: nextTaskId,
                    lastSaved: new Date().toISOString(),
                    version: 4
                };
                
                // Salva sempre localmente (immediato)
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                
                // Prova a salvare su Google Apps Script
                try {
                    await saveToGoogleScript(data);
                    console.log('‚úÖ Salvato su Google Apps Script');
                    showSaveStatus('saved');
                } catch (error) {
                    console.log('‚ö†Ô∏è Google Apps Script non raggiungibile:', error.message);
                    showSaveStatus('saved'); // Mostra "salvato" perch√© localStorage ha funzionato
                    
                    // Retry in background dopo 30 secondi
                    setTimeout(async () => {
                        try {
                            await saveToGoogleScript(data);
                            console.log('‚úÖ Sync ritardata riuscita');
                        } catch (retryError) {
                            console.log('‚ö†Ô∏è Retry sync fallito:', retryError.message);
                        }
                    }, 30000);
                }
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Errore nel salvataggio:', error);
                showSaveStatus('error');
                return false;
            }
        }

        function saveToGoogleScript(data) {
            return new Promise((resolve, reject) => {
                console.log('üì§ Salvando su Google Script...');
                
                // Prova prima JSONP (pi√π affidabile per CORS)
                saveToGoogleScriptJSONP(data)
                    .then(resolve)
                    .catch(error => {
                        console.log('JSONP fallito, provo fetch...');
                        // Fallback a fetch
                        fetch(GOOGLE_APPS_SCRIPT_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'text/plain;charset=utf-8'
                            },
                            body: JSON.stringify({
                                action: 'saveData',
                                data: data
                            })
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(result => {
                            if (result.success) {
                                resolve(result);
                            } else {
                                reject(new Error(result.error || 'Errore sconosciuto'));
                            }
                        })
                        .catch(fetchError => {
                            console.error('Anche fetch fallito:', fetchError);
                            reject(fetchError);
                        });
                    });
            });
        }

        function saveToGoogleScriptJSONP(data) {
            return new Promise((resolve, reject) => {
                const callbackName = 'saveCallback_' + Date.now();
                const script = document.createElement('script');
                
                // Cleanup function
                const cleanup = () => {
                    if (document.head.contains(script)) {
                        document.head.removeChild(script);
                    }
                    delete window[callbackName];
                };
                
                window[callbackName] = function(response) {
                    cleanup();
                    if (response.success) {
                        resolve(response);
                    } else {
                        reject(new Error(response.error || 'Errore sconosciuto'));
                    }
                };
                
                // Per JSONP con POST data, usiamo GET con parametri
                const params = new URLSearchParams({
                    action: 'saveData',
                    data: JSON.stringify(data),
                    callback: callbackName
                });
                
                script.src = `${GOOGLE_APPS_SCRIPT_URL}?${params}`;
                script.onerror = () => {
                    cleanup();
                    reject(new Error('Errore di rete JSONP'));
                };
                
                document.head.appendChild(script);
                
                // Timeout esteso per operazioni di salvataggio
                setTimeout(() => {
                    if (window[callbackName]) {
                        cleanup();
                        reject(new Error('Timeout - operazione troppo lenta'));
                    }
                }, 30000); // 30 secondi per salvataggio
            });
        }

        async function loadData() {
            try {
                // Prima prova localStorage
                const localData = localStorage.getItem(STORAGE_KEY);
                if (localData) {
                    const data = JSON.parse(localData);
                    if (data.version === 4) {
                        teamMembers = data.teamMembers || [...defaultMembers];
                        tasks = data.tasks || [...defaultTasks];
                        deletedTasks = data.deletedTasks || [];
                        nextMemberId = data.nextMemberId || 6;
                        nextTaskId = data.nextTaskId || 6;
                        console.log('‚úÖ Dati caricati da localStorage');
                        
                        // Prova a sincronizzare con Google Script in background
                        loadFromGoogleScript().then(cloudData => {
                            if (cloudData && cloudData.lastSaved > data.lastSaved) {
                                console.log('üîÑ Dati cloud pi√π recenti, aggiornando...');
                                teamMembers = cloudData.teamMembers || [...defaultMembers];
                                tasks = cloudData.tasks || [...defaultTasks];
                                localStorage.setItem(STORAGE_KEY, JSON.stringify(cloudData));
                                if (currentUser) loadDashboard();
                            }
                        }).catch(e => console.log('‚ö†Ô∏è Sync con cloud fallita:', e.message));
                        
                        return true;
                    }
                }
                
                // Prova a caricare da Google Script
                try {
                    const cloudData = await loadFromGoogleScript();
                    if (cloudData) {
                        teamMembers = cloudData.teamMembers || [...defaultMembers];
                        tasks = cloudData.tasks || [...defaultTasks];
                        deletedTasks = cloudData.deletedTasks || [];
                        nextMemberId = cloudData.nextMemberId || 6;
                        nextTaskId = cloudData.nextTaskId || 6;
                        
                        // Salva localmente
                        localStorage.setItem(STORAGE_KEY, JSON.stringify({
                            ...cloudData,
                            version: 4
                        }));
                        
                        console.log('‚úÖ Dati caricati da Google Script');
                        return true;
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è Caricamento da Google Script fallito:', error.message);
                }
                
                // Se tutto fallisce, usa i default
                teamMembers = [...defaultMembers];
                tasks = [...defaultTasks];
                deletedTasks = [];
                nextMemberId = 13;
                nextTaskId = 6;
                
                console.log('üîÑ Inizializzati dati di default');
                saveData();
                return true;
                
            } catch (error) {
                console.error('‚ùå Errore nel caricamento:', error);
                teamMembers = [...defaultMembers];
                tasks = [...defaultTasks];
                return true;
            }
        }

        function loadFromGoogleScript() {
            return new Promise((resolve, reject) => {
                // Prova prima con fetch
                fetch(GOOGLE_APPS_SCRIPT_URL + '?action=loadData', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8'
                    }
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success && result.data) {
                        resolve(result.data);
                    } else {
                        reject(new Error(result.error || 'Nessun dato trovato'));
                    }
                })
                .catch(error => {
                    console.log('Fetch fallito, provo JSONP...');
                    // Fallback a JSONP
                    loadFromGoogleScriptJSONP()
                        .then(resolve)
                        .catch(reject);
                });
            });
        }

        function loadFromGoogleScriptJSONP() {
            return new Promise((resolve, reject) => {
                const callbackName = 'loadCallback_' + Date.now();
                const script = document.createElement('script');
                
                window[callbackName] = function(response) {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    if (response.success && response.data) {
                        resolve(response.data);
                    } else {
                        reject(new Error(response.error || 'Nessun dato trovato'));
                    }
                };
                
                script.src = `${GOOGLE_APPS_SCRIPT_URL}?action=loadData&callback=${callbackName}`;
                script.onerror = () => {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    reject(new Error('Errore di rete JSONP'));
                };
                
                document.head.appendChild(script);
                
                // Timeout dopo 10 secondi
                setTimeout(() => {
                    if (window[callbackName]) {
                        document.head.removeChild(script);
                        delete window[callbackName];
                        reject(new Error('Timeout JSONP'));
                    }
                }, 10000);
            });
        }

        function showSaveStatus(status) {
            const messages = {
                saving: 'üíæ Salvando...',
                saved: '‚úÖ Salvato',
                error: '‚ùå Errore'
            };
            
            if (saveStatus) {
                saveStatus.textContent = messages[status];
                saveStatus.className = `save-status ${status}`;
                saveStatus.style.display = 'block';
                
                if (status === 'saved' || status === 'error') {
                    setTimeout(() => {
                        if (saveStatus) saveStatus.style.display = 'none';
                    }, 2000);
                }
            }
        }

        // === FUNZIONI UI ===
        function showMessage(text, type) {
            if (messageArea) {
                messageArea.textContent = text;
                messageArea.className = `message ${type}`;
                messageArea.style.display = 'block';
            }
        }

        function hideMessage() {
            if (messageArea) {
                messageArea.style.display = 'none';
            }
        }

        // === SISTEMA DI LOGIN ===
        function handleLogin() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            
            hideMessage();
            
            if (!username || !password) {
                showMessage('Inserisci username e password', 'error');
                return;
            }

            showMessage('Verificando credenziali...', 'success');
            
            loadData().then(() => {
                // Verifica Manager
                if (username === credentials.manager.username && password === credentials.manager.password) {
                    currentRole = 'manager';
                    currentUser = { username: username, role: 'manager', name: 'Admin Manager' };
                    loginSuccess();
                    return;
                }

                // Verifica Membro generico
                if (username === credentials.member.username && password === credentials.member.password) {
                    currentRole = 'member';
                    currentUser = { username: username, role: 'member', name: 'Team Member' };
                    loginSuccess();
                    return;
                }

                // Verifica membri personalizzati
                const member = teamMembers.find(m => m.username === username && m.password === password);
                if (member) {
                    currentRole = 'member';
                    currentUser = { 
                        username: username, 
                        role: 'member', 
                        name: `${member.firstName} ${member.lastName}`,
                        id: member.id,
                        avatar: member.avatar
                    };
                    loginSuccess();
                    return;
                }

                showMessage('Credenziali non valide', 'error');
            });
        }

        function loginSuccess() {
            showMessage('Accesso effettuato con successo!', 'success');
            
            setTimeout(() => {
                loginScreen.style.display = 'none';
                dashboardScreen.style.display = 'block';
                
                if (currentRole === 'manager') {
                    userDisplayName.textContent = currentUser.name;
                    userAvatar.textContent = 'AM';
                    document.querySelectorAll('.manager-only').forEach(el => el.classList.add('show'));
                    document.querySelectorAll('.member-only').forEach(el => el.classList.remove('show'));
                } else {
                    userDisplayName.textContent = currentUser.name;
                    userAvatar.textContent = currentUser.avatar || 'TM';
                    document.querySelectorAll('.manager-only').forEach(el => el.classList.remove('show'));
                    document.querySelectorAll('.member-only').forEach(el => el.classList.add('show'));
                }
                
                loadDashboard();
            }, 1000);
        }

        function logout() {
            dashboardScreen.style.display = 'none';
            loginScreen.style.display = 'flex';
            usernameInput.value = '';
            passwordInput.value = '';
            currentUser = null;
            currentRole = null;
        }

        // === DASHBOARD ===
        function loadDashboard() {
            updateStats();
            loadGanttChart();
            if (currentRole === 'manager') {
                loadTasksTable();
                loadMembersTable();
            } else {
                loadUserTasks();
            }
        }

        function updateStats() {
            document.getElementById('totalTasks').textContent = tasks.length;
            document.getElementById('inProgressTasks').textContent = tasks.filter(t => t.status === 'progress').length;
            document.getElementById('completedTasks').textContent = tasks.filter(t => t.status === 'completed').length;
            document.getElementById('totalMembers').textContent = teamMembers.length;
        }

        function refreshData() {
            showMessage('Aggiornando...', 'success');
            loadData().then(() => {
                loadDashboard();
                showMessage('Dati aggiornati!', 'success');
                setTimeout(hideMessage, 2000);
            });
        }

        // === GANTT CHART ===
        function toggleTaskView(view) {
            currentTaskView = view;
            document.getElementById('showActiveBtn').classList.toggle('active', view === 'active');
            document.getElementById('showCompletedBtn').classList.toggle('active', view === 'completed');
            loadGanttChart();
        }

        function generateDateRange(startDate, endDate) {
            const dates = [];
            const start = new Date(startDate);
            const end = new Date(endDate);
            const current = new Date(start);
            
            while (current <= end) {
                dates.push(new Date(current));
                current.setDate(current.getDate() + 1);
            }
            return dates;
        }

        function loadGanttChart() {
            const container = document.getElementById('ganttContainer');
            container.innerHTML = '';
            
            // Filtra task in base alla vista corrente
            const filteredTasks = currentTaskView === 'active' 
                ? tasks.filter(t => t.status !== 'completed')
                : tasks.filter(t => t.status === 'completed');
            
            if (filteredTasks.length === 0) {
                const message = currentTaskView === 'active' ? 'Nessuna attivit√† in corso' : 'Nessuna attivit√† completata';
                container.innerHTML = `<div style="padding: 40px; text-align: center; color: #64748b;"><h3>üìã ${message}</h3></div>`;
                return;
            }
            
            const projectStart = new Date('2025-07-01');
            const projectEnd = new Date('2025-07-31');
            const dateRange = generateDateRange(projectStart, projectEnd);
            const dayWidth = 40;

            // Header
            const header = document.createElement('div');
            header.className = 'gantt-header';
            
            const taskColumn = document.createElement('div');
            taskColumn.className = 'gantt-task-column';
            taskColumn.textContent = 'Attivit√†';
            header.appendChild(taskColumn);

            const timelineHeader = document.createElement('div');
            timelineHeader.className = 'gantt-timeline-header';
            dateRange.forEach(date => {
                const dateCell = document.createElement('div');
                dateCell.className = 'gantt-date-cell';
                dateCell.style.minWidth = dayWidth + 'px';
                dateCell.textContent = `${date.getDate()}/${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                timelineHeader.appendChild(dateCell);
            });
            header.appendChild(timelineHeader);
            container.appendChild(header);

            // Task rows
            filteredTasks.forEach(task => {
                const row = document.createElement('div');
                row.className = 'gantt-row';

                const taskInfo = document.createElement('div');
                taskInfo.className = 'gantt-task-info';
                
                const taskName = document.createElement('div');
                taskName.className = 'task-name';
                taskName.textContent = task.name;
                taskInfo.appendChild(taskName);

                const taskMembers = document.createElement('div');
                taskMembers.className = 'task-members';
                task.members.forEach(memberId => {
                    const member = teamMembers.find(m => m.id === memberId);
                    if (member) {
                        const memberTag = document.createElement('span');
                        memberTag.className = 'member-tag';
                        memberTag.textContent = member.avatar;
                        taskMembers.appendChild(memberTag);
                    }
                });
                taskInfo.appendChild(taskMembers);

                // Mostra commenti se l'attivit√† √® completata
                if (task.status === 'completed' && task.comments && task.comments.length > 0) {
                    const commentsDiv = document.createElement('div');
                    commentsDiv.className = 'task-comments';
                    task.comments.forEach(comment => {
                        const member = teamMembers.find(m => m.id === comment.memberId);
                        const memberName = member ? `${member.firstName} ${member.lastName}` : 'Sconosciuto';
                        commentsDiv.innerHTML += `<div><strong>${memberName}:</strong> ${comment.comment}</div>`;
                    });
                    taskInfo.appendChild(commentsDiv);
                }

                // Timeline
                const timeline = document.createElement('div');
                timeline.className = 'gantt-timeline';
                dateRange.forEach(() => {
                    const dateColumn = document.createElement('div');
                    dateColumn.className = 'gantt-date-column';
                    dateColumn.style.minWidth = dayWidth + 'px';
                    timeline.appendChild(dateColumn);
                });

                const taskStart = new Date(task.startDate);
                const taskEnd = new Date(task.endDate);
                const startOffset = Math.floor((taskStart - projectStart) / (1000 * 60 * 60 * 24));
                const duration = Math.floor((taskEnd - taskStart) / (1000 * 60 * 60 * 24)) + 1;

                const taskBar = document.createElement('div');
                taskBar.className = `gantt-bar progress-${task.status}`;
                taskBar.style.left = (startOffset * dayWidth + 5) + 'px';
                taskBar.style.width = (duration * dayWidth - 10) + 'px';
                
                if (task.status === 'completed' && task.completedAt) {
                    const completedDate = new Date(task.completedAt).toLocaleDateString('it-IT');
                    taskBar.textContent = `Completata ${completedDate}`;
                } else {
                    taskBar.textContent = `${duration}g (${task.progress}%)`;
                }

                timeline.appendChild(taskBar);
                row.appendChild(taskInfo);
                row.appendChild(timeline);
                container.appendChild(row);
            });
        }

        // === GESTIONE MEMBRI ===
        function editMember(memberId) {
            const member = teamMembers.find(m => m.id === memberId);
            if (member) {
                currentEditingMember = member;
                document.getElementById('modalTitle').textContent = 'Modifica Membro';
                document.getElementById('memberFirstName').value = member.firstName;
                document.getElementById('memberLastName').value = member.lastName;
                document.getElementById('memberUsername').value = member.username;
                document.getElementById('memberPassword').value = member.password;
                showModal('memberModal');
            }
        }

        function deleteMember(memberId) {
            if (confirm('Eliminare questo membro?')) {
                teamMembers = teamMembers.filter(m => m.id !== memberId);
                tasks.forEach(task => {
                    task.members = task.members.filter(id => id !== memberId);
                });
                
                saveData();
                loadMembersTable();
                loadTasksTable();
                loadGanttChart();
                updateStats();
                showMessage('Membro eliminato!', 'success');
                setTimeout(hideMessage, 2000);
            }
        }

        function openAddMemberModal() {
            currentEditingMember = null;
            document.getElementById('modalTitle').textContent = 'Aggiungi Nuovo Membro';
            document.getElementById('memberFirstName').value = '';
            document.getElementById('memberLastName').value = '';
            document.getElementById('memberUsername').value = '';
            document.getElementById('memberPassword').value = '';
            showModal('memberModal');
        }

        function saveMemberData() {
            const firstName = document.getElementById('memberFirstName').value.trim();
            const lastName = document.getElementById('memberLastName').value.trim();
            const username = document.getElementById('memberUsername').value.trim();
            const password = document.getElementById('memberPassword').value.trim();

            if (!firstName || !lastName || !username || !password) {
                showMessage('Compila tutti i campi', 'error');
                return;
            }

            if (currentEditingMember) {
                currentEditingMember.firstName = firstName;
                currentEditingMember.lastName = lastName;
                currentEditingMember.username = username;
                currentEditingMember.password = password;
                currentEditingMember.avatar = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
            } else {
                const newMember = {
                    id: nextMemberId++,
                    firstName,
                    lastName,
                    username,
                    password,
                    avatar: (firstName.charAt(0) + lastName.charAt(0)).toUpperCase(),
                    createdAt: new Date().toISOString()
                };
                teamMembers.push(newMember);
            }

            // Salva immediatamente su cloud quando manager modifica membri
            saveData().then(() => {
                console.log('‚úÖ Modifiche membro salvate su cloud');
                closeMemberModal();
                loadMembersTable();
                updateStats();
                showMessage('Membro salvato e sincronizzato!', 'success');
                setTimeout(hideMessage, 2000);
            }).catch(error => {
                console.error('‚ö†Ô∏è Errore salvataggio cloud:', error);
                closeMemberModal();
                loadMembersTable();
                updateStats();
                showMessage('Membro salvato (sync cloud in corso...)', 'success');
                setTimeout(hideMessage, 2000);
            });
        }

        function loadMembersTable() {
            const tbody = document.getElementById('membersTableBody');
            tbody.innerHTML = '';

            teamMembers.forEach(member => {
                const assignedTasks = tasks.filter(task => task.members.includes(member.id)).length;
                const row = document.createElement('tr');
                
                // Nome
                const nameCell = document.createElement('td');
                const nameContainer = document.createElement('div');
                nameContainer.style.display = 'flex';
                nameContainer.style.alignItems = 'center';
                nameContainer.style.gap = '10px';
                
                const memberTag = document.createElement('div');
                memberTag.className = 'member-tag';
                memberTag.textContent = member.avatar;
                
                const memberName = document.createElement('strong');
                memberName.textContent = `${member.firstName} ${member.lastName}`;
                
                nameContainer.appendChild(memberTag);
                nameContainer.appendChild(memberName);
                nameCell.appendChild(nameContainer);
                
                // Username
                const usernameCell = document.createElement('td');
                usernameCell.textContent = member.username;
                
                // Attivit√†
                const tasksCell = document.createElement('td');
                tasksCell.textContent = `${assignedTasks} attivit√†`;
                
                // Azioni
                const actionsCell = document.createElement('td');
                
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-primary';
                editBtn.textContent = '‚úèÔ∏è';
                editBtn.onclick = () => editMember(member.id);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger';
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.style.marginLeft = '5px';
                deleteBtn.onclick = () => deleteMember(member.id);
                
                actionsCell.appendChild(editBtn);
                actionsCell.appendChild(deleteBtn);
                
                row.appendChild(nameCell);
                row.appendChild(usernameCell);
                row.appendChild(tasksCell);
                row.appendChild(actionsCell);
                
                tbody.appendChild(row);
            });
        }

        // === GESTIONE ATTIVIT√Ä ===
        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                currentEditingTask = task;
                document.getElementById('taskModalTitle').textContent = 'Modifica Attivit√†';
                document.getElementById('taskName').value = task.name;
                document.getElementById('taskDescription').value = task.description;
                document.getElementById('taskStartDate').value = task.startDate;
                document.getElementById('taskEndDate').value = task.endDate;
                
                document.querySelectorAll('.difficulty-option').forEach(opt => {
                    opt.classList.remove('selected');
                    if (parseInt(opt.dataset.difficulty) === task.difficulty) {
                        opt.classList.add('selected');
                    }
                });
                
                loadMembersSelector(task.members);
                showModal('taskModal');
            }
        }

        function deleteTask(taskId) {
            if (confirm('Eliminare questa attivit√†?')) {
                tasks = tasks.filter(t => t.id !== taskId);
                saveData();
                loadTasksTable();
                loadGanttChart();
                updateStats();
                showMessage('Attivit√† eliminata!', 'success');
                setTimeout(hideMessage, 2000);
            }
        }

        function openAddTaskModal() {
            currentEditingTask = null;
            document.getElementById('taskModalTitle').textContent = 'Nuova Attivit√†';
            document.getElementById('taskName').value = '';
            document.getElementById('taskDescription').value = '';
            document.getElementById('taskStartDate').value = '';
            document.getElementById('taskEndDate').value = '';
            
            document.querySelectorAll('.difficulty-option').forEach(opt => opt.classList.remove('selected'));
            loadMembersSelector();
            showModal('taskModal');
        }

        function saveTaskData() {
            const name = document.getElementById('taskName').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const startDate = document.getElementById('taskStartDate').value;
            const endDate = document.getElementById('taskEndDate').value;
            
            const selectedDifficulty = document.querySelector('.difficulty-option.selected');
            const selectedMembers = Array.from(document.querySelectorAll('.member-checkbox input:checked')).map(cb => parseInt(cb.value));

            if (!name || !description || !startDate || !endDate || !selectedDifficulty || selectedMembers.length === 0) {
                showMessage('Compila tutti i campi', 'error');
                return;
            }

            const difficulty = parseInt(selectedDifficulty.dataset.difficulty);

            if (currentEditingTask) {
                currentEditingTask.name = name;
                currentEditingTask.description = description;
                currentEditingTask.startDate = startDate;
                currentEditingTask.endDate = endDate;
                currentEditingTask.difficulty = difficulty;
                currentEditingTask.members = selectedMembers;
            } else {
                const newTask = {
                    id: nextTaskId++,
                    name,
                    description,
                    startDate,
                    endDate,
                    difficulty,
                    members: selectedMembers,
                    status: 'planning',
                    progress: 0,
                    createdAt: new Date().toISOString(),
                    assignedAt: new Date().toISOString(),
                    comments: []
                };
                tasks.push(newTask);
            }

            // Salva immediatamente su cloud quando manager modifica attivit√†
            saveData().then(() => {
                console.log('‚úÖ Modifiche attivit√† salvate su cloud');
                closeTaskModal();
                loadTasksTable();
                loadGanttChart();
                updateStats();
                showMessage('Attivit√† salvata e sincronizzata!', 'success');
                setTimeout(hideMessage, 2000);
            }).catch(error => {
                console.error('‚ö†Ô∏è Errore salvataggio cloud:', error);
                closeTaskModal();
                loadTasksTable();
                loadGanttChart();
                updateStats();
                showMessage('Attivit√† salvata (sync cloud in corso...)', 'success');
                setTimeout(hideMessage, 2000);
            });
        }

        function loadMembersSelector(selectedMembers = []) {
            const container = document.getElementById('membersSelector');
            container.innerHTML = '';

            teamMembers.forEach(member => {
                const div = document.createElement('div');
                div.className = 'member-checkbox';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = member.id;
                checkbox.checked = selectedMembers.includes(member.id);
                
                const avatar = document.createElement('div');
                avatar.className = 'member-checkbox-avatar';
                avatar.textContent = member.avatar;
                
                const label = document.createElement('span');
                label.textContent = `${member.firstName} ${member.lastName}`;
                
                div.appendChild(checkbox);
                div.appendChild(avatar);
                div.appendChild(label);
                container.appendChild(div);
            });
        }

        function loadTasksTable() {
            const tbody = document.getElementById('tasksTableBody');
            tbody.innerHTML = '';

            const statusLabels = {
                'planning': 'PIANIFICAZIONE',
                'progress': 'IN CORSO',
                'completed': 'COMPLETATA',
                'review': 'IN REVISIONE'
            };

            tasks.forEach(task => {
                const row = document.createElement('tr');
                
                // Nome
                const nameCell = document.createElement('td');
                nameCell.innerHTML = `<strong>${task.name}</strong><br><small>${task.description}</small>`;
                
                // Membri
                const membersCell = document.createElement('td');
                task.members.forEach(memberId => {
                    const member = teamMembers.find(m => m.id === memberId);
                    if (member) {
                        const tag = document.createElement('span');
                        tag.className = 'member-tag';
                        tag.textContent = member.avatar;
                        tag.style.marginRight = '4px';
                        membersCell.appendChild(tag);
                    }
                });
                
                // Date
                const datesCell = document.createElement('td');
                datesCell.innerHTML = `${formatDate(task.startDate)} - ${formatDate(task.endDate)}`;
                if (task.completedAt) {
                    datesCell.innerHTML += `<br><small>Completata: ${formatDateTime(task.completedAt)}</small>`;
                }
                
                // Stato
                const statusCell = document.createElement('td');
                const statusSpan = document.createElement('span');
                statusSpan.className = `task-card-status status-${task.status}`;
                statusSpan.textContent = statusLabels[task.status];
                statusCell.appendChild(statusSpan);
                
                // Azioni
                const actionsCell = document.createElement('td');
                
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-primary';
                editBtn.textContent = '‚úèÔ∏è';
                editBtn.onclick = () => editTask(task.id);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger';
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.style.marginLeft = '5px';
                deleteBtn.onclick = () => deleteTask(task.id);
                
                actionsCell.appendChild(editBtn);
                actionsCell.appendChild(deleteBtn);
                
                row.appendChild(nameCell);
                row.appendChild(membersCell);
                row.appendChild(datesCell);
                row.appendChild(statusCell);
                row.appendChild(actionsCell);
                
                tbody.appendChild(row);
            });
        }

        // === GESTIONE ATTIVIT√Ä UTENTE ===
        function loadUserTasks() {
            if (!currentUser || !currentUser.id) return;
            
            const userTasks = tasks.filter(task => task.members.includes(currentUser.id) && task.status !== 'completed');
            const container = document.getElementById('userTasksList');
            container.innerHTML = '';

            if (userTasks.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;"><h3>üìù Nessuna attivit√† assegnata o tutte completate</h3></div>';
                return;
            }

            const statusLabels = {
                'planning': 'Pianificazione',
                'progress': 'In Corso',
                'completed': 'Completata',
                'review': 'In Revisione'
            };

            userTasks.forEach(task => {
                const card = document.createElement('div');
                card.className = `user-task-card ${task.status === 'completed' ? 'completed' : ''}`;
                
                card.innerHTML = `
                    <div class="task-card-header">
                        <div class="task-card-title">${task.name}</div>
                        <span class="task-card-status status-${task.status}">${statusLabels[task.status]}</span>
                    </div>
                    <div class="task-card-description">${task.description}</div>
                    <div class="task-card-info">
                        <div class="task-info-item">
                            <div class="task-info-label">Data Inizio</div>
                            <div class="task-info-value">${formatDate(task.startDate)}</div>
                        </div>
                        <div class="task-info-item">
                            <div class="task-info-label">Data Fine</div>
                            <div class="task-info-value">${formatDate(task.endDate)}</div>
                        </div>
                    </div>
                    <div class="completion-section">
                        <textarea class="completion-textarea" id="comment-${task.id}" placeholder="Aggiungi un commento sul completamento dell'attivit√†..."></textarea>
                        <div class="completion-checkbox">
                            <input type="checkbox" id="task-${task.id}" ${task.status === 'completed' ? 'checked' : ''}>
                            <label for="task-${task.id}">Marca come completata</label>
                        </div>
                    </div>
                `;
                
                const checkbox = card.querySelector(`#task-${task.id}`);
                const commentTextarea = card.querySelector(`#comment-${task.id}`);
                
                checkbox.addEventListener('change', () => completeTask(task.id, checkbox.checked, commentTextarea.value));
                
                container.appendChild(card);
            });
        }

        function completeTask(taskId, isCompleted, comment) {
            const task = tasks.find(t => t.id === taskId);
            if (task && isCompleted) {
                if (!comment.trim()) {
                    showMessage('Inserisci un commento per completare l\'attivit√†', 'error');
                    const checkbox = document.querySelector(`#task-${taskId}`);
                    if (checkbox) checkbox.checked = false;
                    return;
                }
                
                task.status = 'completed';
                task.progress = 100;
                task.completedAt = new Date().toISOString();
                
                // Aggiungi il commento
                if (!task.comments) task.comments = [];
                task.comments.push({
                    memberId: currentUser.id,
                    comment: comment.trim(),
                    timestamp: new Date().toISOString()
                });
                
                // IMPORTANTE: Salva su cloud quando membro completa attivit√†
                saveData().then(() => {
                    console.log('‚úÖ Completamento attivit√† salvato su cloud');
                    loadGanttChart();
                    loadUserTasks();
                    updateStats();
                    showMessage('Attivit√† completata e salvata su cloud!', 'success');
                    setTimeout(hideMessage, 3000);
                }).catch(error => {
                    console.error('‚ö†Ô∏è Errore salvataggio cloud:', error);
                    // Anche se il cloud fallisce, mantieni il completamento locale
                    loadGanttChart();
                    loadUserTasks();
                    updateStats();
                    showMessage('Attivit√† completata (salvata localmente, sync cloud in corso...)', 'success');
                    setTimeout(hideMessage, 3000);
                });
            }
        }

        // === GESTIONE MODALI ===
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('show');
                modal.style.display = 'flex';
            }
        }

        function closeMemberModal() {
            const modal = document.getElementById('memberModal');
            if (modal) {
                modal.classList.remove('show');
                modal.style.display = 'none';
            }
        }

        function closeTaskModal() {
            const modal = document.getElementById('taskModal');
            if (modal) {
                modal.classList.remove('show');
                modal.style.display = 'none';
            }
        }

        // === UTILITY ===
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT');
        }

        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return date.toLocaleDateString('it-IT') + ' ' + date.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'});
        }

        function exportToExcel() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Nome,Descrizione,Membri,Data Assegnazione,Data Inizio,Data Fine,Data Completamento,Stato,Progresso,Difficolt√†,Commenti\n";
            
            csvContent += tasks.map(task => {
                const memberNames = task.members.map(id => {
                    const member = teamMembers.find(m => m.id === id);
                    return member ? `${member.firstName} ${member.lastName}` : '';
                }).join('; ');
                
                const comments = task.comments ? task.comments.map(c => {
                    const member = teamMembers.find(m => m.id === c.memberId);
                    const memberName = member ? `${member.firstName} ${member.lastName}` : 'Sconosciuto';
                    return `${memberName}: ${c.comment}`;
                }).join(' | ') : '';
                
                const assignedAt = task.assignedAt ? formatDateTime(task.assignedAt) : '';
                const completedAt = task.completedAt ? formatDateTime(task.completedAt) : '';
                
                return `"${task.name}","${task.description}","${memberNames}","${assignedAt}","${task.startDate}","${task.endDate}","${completedAt}","${task.status}","${task.progress}%","${task.difficulty}","${comments}"`;
            }).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `team_manager_export_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('Dati esportati!', 'success');
            setTimeout(hideMessage, 2000);
        }

        // === INIZIALIZZAZIONE ===
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Inizializzazione Team Manager...');
            
            // Inizializza elementi DOM
            loginScreen = document.getElementById('loginScreen');
            dashboardScreen = document.getElementById('dashboardScreen');
            usernameInput = document.getElementById('usernameInput');
            passwordInput = document.getElementById('passwordInput');
            loginButton = document.getElementById('loginButton');
            messageArea = document.getElementById('messageArea');
            userAvatar = document.getElementById('userAvatar');
            userDisplayName = document.getElementById('userDisplayName');
            saveStatus = document.getElementById('saveStatus');
            googleScriptConnectionStatus = document.getElementById('googleScriptConnectionStatus');
            
            // Event listeners
            loginButton.addEventListener('click', handleLogin);
            usernameInput.addEventListener('keypress', e => e.key === 'Enter' && handleLogin());
            passwordInput.addEventListener('keypress', e => e.key === 'Enter' && handleLogin());
            
            // Difficulty selector
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('difficulty-option')) {
                    document.querySelectorAll('.difficulty-option').forEach(opt => opt.classList.remove('selected'));
                    e.target.classList.add('selected');
                }
            });

            // Close modal on outside click
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    closeMemberModal();
                    closeTaskModal();
                }
            });
            
            // Salva quando chiudi pagina
            window.addEventListener('beforeunload', () => {
                if (currentUser) saveData();
            });
            
            // Carica dati all'avvio
            await loadData();
            console.log('‚úÖ App inizializzata');
            console.log('üìä Membri:', teamMembers.length, '- Attivit√†:', tasks.length);
            console.log('üîê Per le credenziali, fare riferimento alla documentazione interna o chiedere all\'amministratore.');

            // Esegui il test di connessione a Google Apps Script all'avvio
            await testGoogleScriptConnection();
        });

        // Rendi le funzioni disponibili globalmente
        window.openAddMemberModal = openAddMemberModal;
        window.openAddTaskModal = openAddTaskModal;
        window.closeMemberModal = closeMemberModal;
        window.closeTaskModal = closeTaskModal;
        window.saveMemberData = saveMemberData;
        window.saveTaskData = saveTaskData;
        window.logout = logout;
        window.refreshData = refreshData;
        window.exportToExcel = exportToExcel;
        window.completeTask = completeTask;
        window.editMember = editMember;
        window.deleteMember = deleteMember;
        window.editTask = editTask;
        window.deleteTask = deleteTask;
        window.toggleTaskView = toggleTaskView;
        window.testGoogleScriptConnection = testGoogleScriptConnection;
    </script>
</body>
</html>
